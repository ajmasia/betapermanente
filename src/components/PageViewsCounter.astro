---
import EyeIcon from "./icons/EyeIcon.astro";

interface Props {
  path: string;
}

const { path } = Astro.props;
const GOATCOUNTER_SITE = "betapermanente";
---

<span
  id="page-views-counter"
  class="inline-flex items-center gap-1"
  data-path={path}
  data-goatcounter-site={GOATCOUNTER_SITE}
>
  <EyeIcon class="h-4 w-4 flex-shrink-0" />
  <span id="views-count" data-path={path}>...</span>
</span>

<script>
  async function loadPageViews() {
    const counters = document.querySelectorAll("#views-count[data-path]");

    for (const viewsElement of counters) {
      const path = viewsElement.getAttribute("data-path");
      const counterWrapper = viewsElement.closest("#page-views-counter") as HTMLElement | null;
      const site = counterWrapper?.getAttribute("data-goatcounter-site");

      if (!path || !site || !counterWrapper) continue;

      try {
        // Try direct fetch first
        const url = `https://${site}.goatcounter.com/counter/${encodeURIComponent(path)}.json`;
        console.log("Fetching:", url);

        const response = await fetch(url);

        if (!response.ok) {
          console.error(`HTTP error! status: ${response.status}`);
          counterWrapper.style.display = "none";
          continue;
        }

        const data = await response.json();
        console.log("Received data:", data);

        const views = parseInt(data.count || data.count_unique || "0", 10);

        if (views === 0 || isNaN(views)) {
          counterWrapper.style.display = "none";
        } else {
          const formatted =
            views === 1 ? "1 visita" : `${views.toLocaleString("es-ES")} visitas`;
          viewsElement.textContent = formatted;
        }
      } catch (error) {
        console.error("Error fetching page views:", error);
        counterWrapper.style.display = "none";
      }
    }
  }

  // Load views when page loads
  loadPageViews();

  // Reload views after Astro View Transitions
  document.addEventListener("astro:page-load", loadPageViews);
</script>
