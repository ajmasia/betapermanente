---
import EyeIcon from "./icons/EyeIcon.astro";

interface Props {
  path: string;
}

const { path } = Astro.props;
---

<span
  id="page-views-counter"
  class="inline-flex items-center gap-1"
  data-path={path}
>
  <EyeIcon class="h-4 w-4 flex-shrink-0" />
  <span id="views-count">...</span>
</span>

<script>
  const GOATCOUNTER_SITE = "betapermanente";

  function loadPageViews() {
    const counter = document.getElementById("page-views-counter");
    const viewsElement = document.getElementById("views-count");

    if (!counter || !viewsElement) return;

    const path = counter.getAttribute("data-path");
    if (!path) return;

    // Use JSONP to avoid CORS issues
    const callbackName = `goatcounter_${Math.random().toString(36).substring(7)}`;

    // @ts-ignore
    window[callbackName] = function(data: { count: number }) {
      const views = data.count || 0;

      console.log(`Page views for ${path}: ${views}`);

      if (views === 0) {
        // Hide counter if zero views
        counter.style.display = "none";
      } else {
        const formatted =
          views === 1 ? "1 visita" : `${views.toLocaleString("es-ES")} visitas`;
        viewsElement.textContent = formatted;
      }

      // Cleanup
      // @ts-ignore
      delete window[callbackName];
      const script = document.querySelector(`script[src*="${callbackName}"]`);
      if (script) script.remove();
    };

    // Create script tag for JSONP
    const script = document.createElement("script");
    const url = `https://${GOATCOUNTER_SITE}.goatcounter.com/counter/${encodeURIComponent(path)}.json?callback=${callbackName}`;
    script.src = url;

    console.log(`Attempting to load views from: ${url}`);

    script.onerror = function() {
      console.error(`Error loading page views from: ${url}`);
      console.error("Possible causes:");
      console.error("1. Public statistics not enabled in GoatCounter settings");
      console.error("2. No data available yet for this path");
      console.error("3. GoatCounter site code incorrect");
      counter.style.display = "none";
      // @ts-ignore
      delete window[callbackName];
    };

    document.head.appendChild(script);
  }

  // Load views when page loads
  loadPageViews();

  // Reload views after Astro View Transitions
  document.addEventListener("astro:page-load", loadPageViews);
</script>
