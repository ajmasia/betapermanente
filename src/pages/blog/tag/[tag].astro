---
import { getCollection } from "astro:content";
import type { CollectionEntry, GetStaticPaths } from "astro:content";

import MainLayout from "../../../layouts/MainLayout/MainLayout.astro";
import Card from "../../../components/Card/Card.astro";
import Tag from "../../../components/Tag.astro";
import { SITE } from "../../../config.ts";

type BlogPost = CollectionEntry<"blog">;

export const getStaticPaths = (async () => {
  const posts = await getCollection(
    "blog",
    ({ data }: BlogPost) => data.draft !== true && data.lang === "es",
  );

  // Get all unique tags
  const tags = new Set<string>();
  posts.forEach((post) => {
    post.data.tags?.forEach((tag) => {
      tags.add(tag.toLowerCase().replace(/\s+/g, "-"));
    });
  });

  // Create a path for each tag
  return Array.from(tags).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}) satisfies GetStaticPaths;

const { tag } = Astro.props;

// Get all posts with this tag
const posts = await getCollection(
  "blog",
  ({ data }: BlogPost) =>
    data.draft !== true &&
    data.lang === "es" &&
    data.tags?.some((t) => t.toLowerCase().replace(/\s+/g, "-") === tag),
);

// Sort posts by date (most recent first)
posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get the original tag name from the first post
const originalTagName = posts[0]?.data.tags?.find(
  (t) => t.toLowerCase().replace(/\s+/g, "-") === tag
) || tag;
---

<MainLayout
  title={`${SITE.title}: ${originalTagName}`}
  description={`Artículos sobre ${originalTagName}`}
>
  <div class="container mx-auto md:max-w-[90%] lg:max-w-[95%] xl:max-w-7xl">
    <div class="mb-8">
      <a href="/blog" class="link text-sm">&larr; Volver al blog</a>
    </div>
    <h1 class="flex items-center gap-3">
      <span>Publicaciones sobre</span>
      <Tag tag={originalTagName} linked={false} />
    </h1>
    <p class="text-slate-500 dark:text-slate-400 mb-8">
      {posts.length} {posts.length === 1 ? "artículo" : "artículos"}
    </p>
    <div class="md:grid md:grid-cols-2 md:gap-8 xl:block [&>article:last-child:nth-child(odd)]:md:col-span-2 [&>article:last-child:nth-child(odd)]:md:max-w-[calc(50%-1rem)] [&>article:last-child:nth-child(odd)]:md:mx-auto [&>article:last-child:nth-child(odd)]:xl:max-w-none">
      {
        posts.map((post) => (
          <Card
            post={post}
            variant="horizontal"
            showImage={true}
            linkTags={true}
            headingLevel="h2"
            class="mb-18 sm:mb-14 md:mb-0 xl:mb-14 last:mb-0"
          />
        ))
      }
    </div>
  </div>
</MainLayout>
