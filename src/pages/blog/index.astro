---
import { getPageTitle } from "../../lib/navigation.ts";

import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

import MainLayout from "../../layouts/MainLayout/MainLayout.astro";
import CalendarIcon from "../../components/icons/CalendarIcon.astro";
import ClockIcon from "../../components/icons/ClockIcon.astro";
import Tag from "../../components/Tag.astro";
import {
  calculateReadingTime,
  formatReadingTime,
} from "../../lib/readingTime.ts";

type BlogPost = CollectionEntry<"blog">;

const posts: BlogPost[] = await getCollection(
  "blog",
  ({ data }: BlogPost) => data.draft !== true && data.lang == "es",
);

// Sort posts by date (most recent first)
posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<MainLayout
  title={getPageTitle(Astro.url.pathname)}
  description="Artículos sobre desarrollo de software, tecnología y aprendizaje continuo"
>
  <div class="container mx-auto md:max-w-[90%] lg:max-w-[95%] xl:max-w-7xl">
    <div class="flex items-center justify-between mb-4">
      <h1 class="mb-0">Blog</h1>
      <a
        href="/blog/tags"
        class="text-sm text-slate-500 dark:text-slate-400 hover:text-red-400 dark:hover:text-red-400 transition-colors"
      >
        Ver todos los tags →
      </a>
    </div>
    <div class="md:grid md:grid-cols-2 md:gap-8 xl:block [&>article:last-child:nth-child(odd)]:md:col-span-2 [&>article:last-child:nth-child(odd)]:md:max-w-[calc(50%-1rem)] [&>article:last-child:nth-child(odd)]:md:mx-auto [&>article:last-child:nth-child(odd)]:xl:max-w-none">
      {
        posts.map((post) => (
          <article class="mb-18 sm:mb-14 md:mb-0 xl:mb-14 last:mb-0 rounded-2xl bg-slate-50 dark:bg-slate-800 overflow-hidden xl:max-h-[210px] xl:flex xl:flex-row">
            {post.data.heroImage && (
              <a href={`/blog/${post.slug}`} class="block xl:hidden">
                <img
                  src={post.data.heroImage}
                  alt={post.data.title}
                  class="w-full h-auto"
                />
              </a>
            )}
            {post.data.heroImage && (
              <a
                href={`/blog/${post.slug}`}
                class="hidden xl:block flex-shrink-0"
              >
                <img
                  src={post.data.heroImage}
                  alt={post.data.title}
                  class="h-[210px] w-auto"
                />
              </a>
            )}
            <div class="p-6 flex-1 overflow-hidden">
              <h2 class="text-2xl font-semibold mb-2">
                <a href={`/blog/${post.slug}`} class="link">
                  {post.data.title}
                </a>
              </h2>
              <p class="mb-2 line-clamp-2 min-h-[3rem]">
                {post.data.description || ""}
              </p>
              <p class="flex text-slate-500 dark:text-slate-400 text-sm items-center mb-2">
                <span class="inline-flex items-center gap-1">
                  <CalendarIcon class="h-4 w-4 flex-shrink-0" />
                  <span class="pt-0.5">
                    {post.data.date.toLocaleDateString("es-ES", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })}
                  </span>
                </span>
                <span class="mx-2">·</span>
                <span class="inline-flex items-center gap-1">
                  <ClockIcon class="h-4 w-4 flex-shrink-0" />
                  <span>
                    {formatReadingTime(calculateReadingTime(post.body))}
                  </span>
                </span>
              </p>
              {post.data.tags && post.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {post.data.tags.map((tag: string) => (
                    <Tag tag={tag} />
                  ))}
                </div>
              )}
            </div>
          </article>
        ))
      }
    </div>
  </div>
</MainLayout>
